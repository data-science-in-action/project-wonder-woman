---
title: "国内外疫情态势对比分析"
author: "刘崟  慕慧君  肖雨婷  王洁  卢晋萍"
date: "2020/5/29"
geometry:
- lmargin=2.5cm
- rmargin=2.5cm
fontsize: 12
output: 
  html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 摘要



# 1 引言

　　2020年初，不明原因的病毒性肺炎在中国武汉市爆发，随后，其病原体被确定为新型冠状病毒，并在全球多个国家相继出现。根据世界卫生组织报告，1月11日，西太平洋地区出现41例确诊病例，1月13日，东南亚出现1例确诊病例，1月20日，美洲出现1例确诊病例，1月24日，欧洲出现3例确诊病例，1月29日，地中海东部地区出现4例确诊病例，2月25日，非洲出现1例确诊病例。截止5月12日 6:42 CEST（Central Europe Summer Time ， 西 太 平 洋 地 区 新 冠 肺炎累积确诊病例已达到161872例，东南亚地区累积确诊107354例，美洲累积确诊1743717例，欧洲累积确诊1755790例，地中海东部地区累积确诊281744例，非洲累积确诊46829例。
    
　　从以上数据可以看出，同一病毒性肺炎在不同地区和国家呈现出不同的发展态势。研究疫情发展规律，掌握疫情的发展态势，有利于政府安抚民心以及科学有效地制定防控政策。本文对全球疫情的发展态势进行了可视化分析，然后选取一些代表性国家对新冠肺炎的不同发展趋势类型进行了分析，并对各个国家肺炎发展趋势进行了拟合和预测，为科学有效地控制疫情提供相关建议。

# 2 描述性统计分析

## 2.1 全球每日新增病例

　　对各国每日新增病例进行比较分析，取2019-12-31日至2020-05-28的各国COVID-19每日新增病例的数据，对比各国COVID-19发展的速度和各国的对抗效力。由于各个国家病例数相差较大，所以这里对每个国家/地区的新增病例的进行归一化（（1）式），范围从0到1。公式如下：

$$
f(x)=\frac {x-min(x)}{max(x)-min(x)} \tag{1}
$$

　　现实中的数据并不像数学中的函数那样光滑，每日新增病例具有一定的波动性，单日新增最大值出现并不意味着拐点出现，因此，当持续一段时间的总体趋势在下降，或者连续一段时间下降，才能说一个地区疫情的拐点确实到来了。

　　图1这种生动的可视化聚焦于病毒从中国开爆发，随后病毒在世界其他地区扩散的时间顺序。为了增强视觉效果，根据每个国家/地区达到每日病例高峰（深红色框）的日期，将前90个国家/地区放在两个半对角线上。


```{r, fig.align='center', fig.cap="图1 全球归一化的每日新增病例动态图", echo = FALSE, message=FALSE}
library(tidyverse)
library(reshape2)
library(purrrlyr)

# download dataset
df <- read_csv('data/full_data.csv')

# normalization function
fun_normalize <- function(x) {
  return ((x - min(x)) / (max(x) - min(x)))
}

# preprocess data
df_prep <- df %>%
  filter(location != 'World') %>%
  
  group_by(location) %>%
  # remove earlier dates
  filter(date > as.Date('2020-01-15', format = '%Y-%m-%d')) %>%
  # remove coutries with less than 1000 total cases
  filter(max(total_cases) > 1000) %>%
  # replace negative values with the mean 
  mutate(new_cases = ifelse(new_cases < 0,
                            round((lag(new_cases, default = 0) + lead(new_cases, default = 0)) / 2),
                            new_cases)) %>%
  ungroup() %>%
  select(location, date, new_cases) %>%
  # prepare data for normalization
  dcast(., date ~ location, value.var = 'new_cases') %>%
  # replace NAs with 0
  dmap_at(c(2:ncol(.)), function(x) ifelse(is.na(x), 0, x)) %>%
  # normalization
  dmap_at(c(2:ncol(.)), function(x) fun_normalize(x)) %>%
  melt(., id.vars = c('date'), variable.name = 'country') %>%
  mutate(value = round(value, 6))


# define countries order for plots
country_ord_1 <- df_prep %>%
  group_by(country) %>%
  filter(value == 1) %>%
  ungroup() %>%
  arrange(date, country) %>%
  distinct(country) %>%
  mutate(is_odd = ifelse((row_number() - 1) %% 2 == 0, TRUE, FALSE))

country_ord_anim <- bind_rows(country_ord_1 %>%
                                filter(is_odd == TRUE) %>%
                                arrange(desc(row_number())),
                              country_ord_1 %>%
                                filter(is_odd == FALSE))

# data for animated plot
df_plot_anim <- df_prep %>%
  mutate(country = factor(country, levels = c(as.character(country_ord_anim$country)))) %>%
  group_by(country) %>%
  mutate(first_date = min(date[value >= 0.03])) %>%
  mutate(cust_label = ifelse(date >= first_date, as.character(country), '')) %>%
  ungroup()


# color palette
cols <- c('#e7f0fa','#c9e2f6', '#95cbee', '#0099dc', '#4ab04a', '#ffd73e', '#eec73a', '#e29421', '#e29421', '#f05336', '#ce472e')


# Animated Heatmap plot
p <- ggplot(df_plot_anim, aes(y = country, x = date, fill = value)) +
  theme_minimal() +
  geom_tile(color = 'white', width = .9, height = .9) +
  scale_fill_gradientn(colours = cols, limits = c(0, 1),
                       breaks = c(0, 1),
                       labels = c('0', 'max'),
                       guide = guide_colourbar(ticks = T, nbin = 50, barheight = .5, label = T, barwidth = 10)) +
  
  geom_text(aes(x = first_date, label = cust_label), size = 3, color = '#797D7F') +
  scale_y_discrete(position = 'right') +
  coord_equal() +
  
  theme(legend.position = 'bottom',
        legend.direction = 'horizontal',
        plot.title = element_text(size = 20, face = 'bold', vjust = 2, hjust = 0.5),
        axis.text.x = element_text(size = 8, hjust = .5, vjust = .5, face = 'plain'),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
  ) +
  ggtitle('全球COVID-19传播：归一化的每日新增病例')


# animated chart
library(gganimate)
library(gifski)

anim <- p + 
  transition_components(date) +
  ggtitle('全球COVID-19传播：归一化的每日新增病例',
          subtitle = 'Date {frame_time}') +
  shadow_mark()

animate(anim,
        nframes = as.numeric(difftime(max(df_plot_anim$date), min(df_plot_anim$date), units = 'days')) + 1,
        duration = 12,
        fps = 12,
        width = 1000,
        height = 840,
        start_pause = 5,
        end_pause = 25,
        renderer = gifski_renderer())

```

　　为了进行更详细的分析，创建了图2，它与图1的动画相同，但是国家/地区从下到上排序。从图2中可以看到，1月的下旬COVID-19开始在中国爆发，到三月左右国内疫情基本得到控制，每日新增数变得很少；紧随中国之后的是韩国，3月初出现单日新增最高值（首现拐点），持续了几天数量较大的单日新增，之后单日新增数量保持在较小值的一定范围波动。

```{r, fig.width =10, fig.height = 8, fig.align='center',  fig.cap="图2 全球归一化的每日新增病例", echo=FALSE, message=FALSE}
# Heatmap plot 1
df_plot_1 <- df_prep %>%
  mutate(country = factor(country, levels = c(as.character(country_ord_1$country)))) %>%
  group_by(country) %>%
  mutate(first_date = min(date[value >= 0.03])) %>%
  ungroup()

ggplot(df_plot_1, aes(y = country, x = date, fill = value)) +
  theme_minimal() +
  geom_tile(color = 'white', width = .9, height = .9) +
  scale_fill_gradientn(colours = cols, limits = c(0, 1),
                       breaks = c(0, 1),
                       labels = c('0', 'max'),
                       guide = guide_colourbar(ticks = T, nbin = 50, barheight = .5, label = T, barwidth = 10)) +
  
  geom_text(aes(x = first_date, label = country), size = 3, color = '#797D7F') +
  scale_y_discrete(position = 'right') +
  coord_equal() +
  
  theme(legend.position = 'bottom',
        legend.direction = 'horizontal',
        plot.title = element_text(size = 20, face = 'bold', vjust = 2, hjust = 0.5),
        axis.text.x = element_text(size = 8, hjust = .5, vjust = .5, face = 'plain'),
        axis.text.y = element_text(size = 6, hjust = .5, vjust = .5, face = 'plain'),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
  ) 
```

　　图3以每日最多新增病例为中心，该图显示了前一阶段和后续阶段的时间和强度。图中可以看到，中国的单日新增最大值基本就是拐点，之后每日新增连续下降；意大利、德国、西班牙、法国等出现单日新增最大之后，还持续了较长一段时间的增减反复，才迎来了拐点；而英国达到每日新增病例最大值后的近一个月还未迎来拐点。美国在出现单日新增最大之后，每日新增还在较大值波动，也就是说美国的新冠累计确诊还在较大的增长，拐点还未显现。

```{r, fig.width = 10, fig.height = 6, fig.align='center',  fig.cap="图3 各国对抗COVID-19的效力比较", echo=FALSE, message=FALSE}
# Heatmap plot 2
df_plot_2 <- df_prep %>%
  group_by(country) %>%
  filter(date >= min(date[value > 0])) %>%
  arrange(date, .by_group = TRUE) %>%
  mutate(centr_day = min(row_number()[value == 1]),
         n_day = row_number() - centr_day) %>%
  ungroup()

country_ord_2 <- df_plot_2 %>%
  group_by(country) %>%
  filter(date >= min(date[value == 1])) %>%
  summarise(value = sum(value)) %>%
  ungroup() %>%
  arrange(value, country) %>%
  distinct(country)

df_plot_2 <- df_plot_2 %>%
  mutate(country = factor(country, levels = c(as.character(country_ord_2$country)))) %>%
  group_by(country) %>%
  mutate(first_date = min(n_day[value >= 0.01])) %>%
  ungroup()


# Heatmap plot 2
ggplot(df_plot_2, aes(y = country, x = n_day, fill = value)) +
  theme_minimal() +
  geom_tile(color = 'white', width = .9, height = .9) +
  scale_fill_gradientn(colours = cols, limits = c(0, 1),
                       breaks = c(0, 1),
                       labels = c('0', 'max'),
                       guide = guide_colourbar(ticks = T, nbin = 50, barheight = .5, label = T, barwidth = 10)) +
  
  geom_text(aes(x = first_date, label = country), size = 3, color = '#797D7F') +
  coord_equal() +
  
  theme(legend.position = 'bottom',
        legend.direction = 'horizontal',
        plot.title = element_text(size = 20, face = 'bold', vjust = 2, hjust = 0.5),
        axis.text.x = element_text(size = 8, hjust = .5, vjust = .5, face = 'plain'),
        #axis.text.y = element_text(size = 6, hjust = .5, vjust = .5, face = 'plain'),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
  ) 

```


## 2.2 2019年GDP前十各国疫情态势对比

　　此次选取了2019年GDP前10的国家进行疫情累计确诊的对比分析，GDP前十的国家中大多数都是在国际上有一定影响力的发达国家，且国家综合实力较强，或者是发展中的人口大国。如果大国在抗疫方面做的很好，就可以帮助一些国家实力较弱的国家进行抗疫；如果大国自己的疫情都不能控制，那么我们极有可能会较长时间的跟病毒做斗争。

　　为了直观的比较各国疫情时间发展，横轴取各国第100例病人确诊的时间作为起始点，由于美国累计确诊人数较多，纵轴数值较大，导致其他国家的累计确诊人数的曲线轨迹不明显；因此取这十个国家中累计确诊人数第二多的巴西作为纵轴取值标准。

　　图4中红色虚线代表美国，可以看到在确诊第100例新冠肺炎之后的35天左右，美国累计确诊人数已经超过了35万人；同样的时间跨度，中国抗疫已经接近后期，剩余的8个国家累计确诊还处在不同程度的增长阶段。

　　在拐点方面，可以看到疫情较为严重的欧洲：意大利、德国和法国均在出现累计确诊第100例病人40多天后出现了拐点；至5月28日，英国距离出现第100例COVID-19累计确诊病例过了80天，图中英国显示累计确诊病例增速放缓，如果未来一段时间能够加强疫情防控，相信拐点很快将会到来；同时，巴西、印度的疫情还在进一步恶化,累计确诊病例增速加快。日本的在近5月28日几天增长较为平缓，只要后续时间疫情突然反跳的情况，按照目前的趋势日本的COVID-19基本得到控制。

```{r, fig.align='center',  fig.cap="图4 2019年GDP前十国家累计确诊数比较", echo=FALSE, message=FALSE}
GDP_10 <- read_csv('data/GDP_10.csv')

days <- GDP_10[,1]
days<-unlist(days)
tc <- GDP_10[,9]
tc<-unlist(tc)
US <- GDP_10[,2]
US<-unlist(US)
CN <- GDP_10[,3]
CN<-unlist(CN)
JP <- GDP_10[,4]
JP<-unlist(JP)
DE <- GDP_10[,5]
DE<-unlist(DE)
IN <- GDP_10[,6]
IN<-unlist(IN)
FR <- GDP_10[,7]
FR<-unlist(FR)
UK <- GDP_10[,8]
UK<-unlist(UK)
BR <- GDP_10[,9]
BR<-unlist(BR)
IT <- GDP_10[,10]
IT<-unlist(IT)
CA <- GDP_10[,11]
CA<-unlist(CA)
plot(tc~days, type = "l", lty=1)
lines(US~days, col = "red", lty=2)
lines(CN~days, col = "red", lwd=2, lty=1)
lines(JP~days, col = "yellow",lwd=2, lty=1)
lines(DE~days, col = "green",lwd=2, lty=1)
lines(IN~days, col = "grey", lwd=2,lty=1)
lines(FR~days, col = "blue",lwd=2, lty=1)
lines(UK~days, col = "black", lwd=2,lty=1)
lines(BR~days, col = "orange",lwd=2, lty=1)
lines(IT~days, col = "brown", lwd=2,lty=1)
lines(CA~days, col = "purple", lwd=2,lty=1)
legend("topleft",cex=0.5,c("CN","JP","DE","IN", "FR", "UK", "BR", "IT", "CA"),col=c("red","yellow","green","grey", "blue", "black","orange", "brown", "purple"),lty=1)
```

　　由于各国确诊人数相差较大，比较各国累计死亡人数意义不大。这里将采用COVID-19各国累计死亡人数占累计确诊人数的比例来作为死亡率，公式为：
$$dr=\frac {TotalDeaths}{TotolCases}*100  \tag{2}$$

　　图5展示了2019年GDP前十的国家出现第一例COVID-19h患者死亡后至2020年5月28日的死亡率的变化，横轴为各国出现第一例患者死亡后的时间跨度，纵轴为各国死亡率（%）。从图中可以看出，在出现COVID-19患者死亡初期，由于累计确诊人数少，死亡率会有较大的波动，随着累计确诊人数增多（分母增多），死亡率呈一定的趋势波动。累计确诊人数遥遥领先的美国，最近一个多月死亡率在却在6%上下波动；反而是累计确诊人数不到15万人的法国，死亡率快速增长，目前已经超过的19%；虽然日本近日的死亡率呈一定的上升趋势，但能够加强疫情防控，参考中国的死亡率，这种趋势不会持续上升。除此之外，意大利的死亡率近来在14%波动；英国的死亡率在升到超过15%后，缓降至14%波动。这些线图中最令人惊讶的是德国，德国的累计确诊人数虽然不是最多，却是高于法国的，从图4中也能看出；而德国的死亡率至今从未超过5%，且最近增速平缓，德国能做到这一点除了健全医疗体系、充足医疗储备之外，也和德国强大的科研能力以及特殊的社会、家庭结构紧密相关。[这篇报道](https://baijiahao.baidu.com/s?id=1663506858709406024&wfr=spider&for=pc)很好的解释了德国能够做到低死亡率、高治愈率的原因。
　　
```{r, fig.align='center',  fig.cap="图5 2019年GDP前十国家COVID-19死亡率比较", echo=FALSE, message=FALSE}
GDP_10_dr <- read_csv('data/GDP_10_dr.csv')
days <- GDP_10_dr[,1]
days<-unlist(days)
dr <- GDP_10_dr[,7]
dr<-unlist(dr)
US <- GDP_10_dr[,2]
US<-unlist(US)
CN <- GDP_10_dr[,3]
CN<-unlist(CN)
JP <- GDP_10_dr[,4]
JP<-unlist(JP)
DE <- GDP_10_dr[,5]
DE<-unlist(DE)
IN <- GDP_10_dr[,6]
IN<-unlist(IN)
FR <- GDP_10_dr[,7]
FR<-unlist(FR)
UK <- GDP_10_dr[,8]
UK<-unlist(UK)
BR <- GDP_10_dr[,9]
BR<-unlist(BR)
IT <- GDP_10_dr[,10]
IT<-unlist(IT)
CA <- GDP_10_dr[,11]
CA<-unlist(CA)
plot(dr~days, type = "l", lty=1)
lines(US~days, col = "cornflowerblue", lty=1)
lines(CN~days, col = "red", lwd=2, lty=1)
lines(JP~days, col = "yellow",lwd=2, lty=1)
lines(DE~days, col = "green",lwd=2, lty=1)
lines(IN~days, col = "grey", lwd=2,lty=1)
lines(FR~days, col = "blue",lwd=2, lty=1)
lines(UK~days, col = "black", lwd=2,lty=1)
lines(BR~days, col = "orange",lwd=2, lty=1)
lines(IT~days, col = "brown", lwd=2,lty=1)
lines(CA~days, col = "purple", lwd=2,lty=1)
legend("topleft",cex=.5,c( "US", "CN","JP","DE","IN", "FR", "UK", "BR", "IT", "CA"),col=c( "cornflowerblue","red","yellow","green","grey", "blue", "black","orange", "brown", "purple"),lty=1)
```


# 3 聚类分析

## 3.1 聚类分析简介

　　统计学中，聚类分析是将随机现象进行归类的统计学方法，已广泛应用于医学科学研究之中。聚类分析也成为群分析、点群分析，是研究分类的一种多元统计方法。

　　但是，聚类并不完全等同于分类。两者最大的不同在于，聚类所要求划分的类是未知的。从统计学的观点看，聚类分析是通过数据建模简化数据的一种方法。聚类分析是一种探索性的分析，在分类的过程中，人们不必事先给出一个分类的标准，聚类分析能够从样本数据出发，自动进行分类。聚类分析所使用方法的不同，常常会得到不同的结论。不同研究者对于同一组数据进行聚类分析，所得到的聚类数未必一致。 

### 3.1.1 聚类分析的相关定义

### （1）基本思想
　　由于研究的样品或指标（变量）之间存在着程度不同的相似性（亲疏关系），故可根据一批样本的多个观测指标，具体找出一些能够度量样品或指标之间相似程度的统计量，以这些统计量为划分类型的依据，把一些相似程度较大的样品进行（或指标）聚合为一类，把另外一些彼此之间相似程度较大的样品（或指标）又聚合为另一类，关系密切的聚合到一个小的分类单位，关系疏远的聚合到一个大的分类单位，直到把所有的样品（或指标）聚合完毕，这就是聚类的基本思想。

### （2）类型
　　通常根据分类对象的不同，简化聚类分析分为Q型聚类分析和R型聚类分析两大类。
<br>$\bullet$  Q型聚类分析
<br>　　Q型聚类分析是对样本进行分类处理，又称为样本聚类分析。对样本进行聚类的目的是将分类不明确的样本按性质相似程度分为若干组，从而发现同类样本的共性和不同类样本间的差异。Q型聚类分析可以综合利用多个变量的信息对样本进行分类，其分类结果直观，输出的聚类谱系图可以非常清楚地表现其数值分类的结果，并且比传统分类方法更加细致、全面、合理。
<br>$\bullet$  R型聚类分析
<br>　　R型聚类分析是对指标进行分类处理，又称为指标聚类分析。对指标进行聚类的目的是将分类不明确的指标按性质相似程度分为若干组，从而在尽量不损失信息的条件下，用一组少量的指标破来代替原来的多个指标。通过R型聚类分析，不但可以了解个别变量之间的关系，而且可以了解各个指标组合之间的亲疏关系。此外，还可以根据变量的分类结果以及它们之间俺的关系，选择主要变量进行回归分析或Q型聚类分析。

　　根据本报告进行聚类分析所使用的数据以及聚类的目的，进行的聚类分析属于Q型聚类分析，即样本聚类分析。因此，在下一小节统计量介绍的部分，只分析Q型聚类分析所使用的距离系数。


### 3.1.2 聚类分析的统计量

　　不管是Q型聚类还是R型聚类，关键在于如何让定义相似性，即如何将其数量化。聚类分析中用来衡量样本个体直接按属性相似程度的统计量以及指标变量之间属性相似程度的统计量是不一样的，前者使用统计量是距离系数，后者使用的统计量是相似系数。常用的距离系数分别由明氏距离、马氏距离、兰氏距离和类间距离。

　　设有n个样本，p个指标，因此可以构成一个$n \times p$维的数据矩阵：

$X=\left[ \begin{matrix} x_{11} &x_{12} &\dots& x_{1p} \\  x_{21} &x_{22} &\dots& x_{2p} \\x_{i1} &x_{i2} &\dots& x_{ip}\\ \vdots & \vdots & \ddots & \vdots \\x_{j1} &x_{j2} &\dots& x_{jp}\\x_{n1} &x_{n2} &\dots& x_{np} \end{matrix} \right]$

　　由于每个样本有p个指标，故可将每个样本看作p维空间中的一个点，n个样本就构成了p维空间中的n个点。因此，可以用距离来度量样本之间的接近程度。令$x_i=(x_{i1},…,x_{it},…,x_{ip})^T$是第i个样本观察值，$x_j=(x_{j1},…,x_{jt},…,x_{jp})^T$是第j个样本观察值，那么这两个样本$x_i$和$x_j$之间几个常用的距离系数如下所示：

### （1）明氏距离

　　公式:

<br>$d_{ij}(q)=[\sum_{t=1}^{p} \rvert x_{it}-x_{jt} \lvert^q]^{1/q}$

　　当q=1是，为绝对距离。当q=2是，为欧式距离。当q=3是，为切比雪夫距离。当各个变量测量值差距悬殊是，直接计算其明氏距离进行聚类并不合理，需要先对数据进行标准化的处理，然后用标准化后的数据计算距离。明氏距离，特别是其中的欧式距离是人们较为熟悉的，也是使用最多的距离。但明氏距离也具有明显的缺陷，主要表现在：一，它与各指标的量纲有关；而，它没有考虑指标之间的相关性。欧式距离也不例外。

### （2）马氏距离

　　设$\Sigma$表示指标的协差阵，即

$\Sigma=（\sigma_{ij}）_{p \times p}$

其中，

$\sigma_{ij}=\frac{1}{n-1}\sum_{a=1}^{n}(x_{ai}-\overline{x_i})(x_{aj}-\overline{x_j}) \qquad i,j=1,…,p$

<br>$\overline{x_i}=\frac{1}{n}\sum_{a=1}^{n}x_{ai},\overline{x_j}=\frac{1}{n}\sum_{a=1}^{n}x_{aj}$

如果$\Sigma^{-1}$存在，则两个样品之间的马氏距离为：

$d^2_{ij}(M)=(x_i-x_j)'\Sigma^{-1}(x_i-x_j)$

　　这里的$x_i$为样本$x_i$的p个指标组成的向量，即原始资料阵的第i行向量。样本$x_j$类似。
马氏距离即排除了各指标之间按相关性的干扰，而且不受各指标量纲的影响。除此之外，它还有将原始数据作一线性变换后，马氏距离不不变的优点。

### （3）其他距离

　　由于本次报告篇幅的限制，仅对兰氏距离和类间距离做大致介绍。
兰氏距离仅适用于一切$x_{ij}>0$的情况。这个距离有助于克服个指标之间量纲的影响，但没有考虑指标之间的相关性。类间距离是用来度量一个类（一组样本）与另一个类（另一组样本）之间距离的统计量。此距离的定义方法很多，且都是以距离系数（如欧式距离）为依据的。


# 4 趋势拟合及预测
　　本章节通过拟合患者比例和增长率的变化来分析疫情趋势，将复杂的外界影响因素视为患者数量增长的环境压力，以拟合生态增长曲线的方式解读2019-nCoV病毒的感染患者例数变化，分析国内外COVID-19疫情现状并预估发展趋势。

    
## 4.1 COVID-19预测预报非线性模型及其机理简介

　　在时间序列里，有些变量的增长量最初比较小，随时间的增加逐渐增长而达到一个快速增长时期，而后增长速度趋缓，最终达到稳定的总增长量，这一过程若用曲线来表示，则是一种拉长的S形曲线。这种S形曲线因变量的增长特性的不同而呈现出多样性变化。通常传染病的累计病例遵循S形曲线增长。Logistic函数是一种常见的S形函数，它是皮埃尔·弗朗索瓦·韦吕勒在1844或1845年在研究它与人口增长的关系时命名的。该模型广泛应用于生物繁殖和生长过程、人口增长过程模拟。在分析COVID-19疫情变化时，可以将患者看作在限定环境中数量增长的物种，实际中病毒的传播也存在人为管控或自然阻力，因此2019-nCoV病毒的感染者例数不会无限制的增长，在一定空间范围内应符合Logistic增长曲线。

  
Logistic方程,即常微分方程如下：$$\frac {dP} {dt} =rP*(1-\frac {P} {K})$$ 将上述方程求解，可以得到Logistic函数：$$P(t)=\frac {KP_0 e^rt} {K+P_0(e^rt-1)}$$    
其中$P_0$为初始值，$r$为衡量曲线变化快慢，$t$为时间。$\frac{dP}{dt}$为种群增长率（单位时间个体数量的改变），$P$为种群的大小（个体的数量），$K$为可能出现的最大种群数（上渐近线）或承载力。


## 4.2 数据说明与方法

### 4.2.1 数据说明

　　本章节选用2019年GDP前十的国家：美国、中国、日本、德国、印度、法国、英国、巴西、意大利和加拿大。对GDP-TOP10的国家自2019年12月31日至2020年5月24日COVID-19累计确诊病例进行拟合和预测，以及对GDP-TOP10的国家最终流行规模的预测值进行比较。同时，计算GDP-TOP10的国家自2019年12月31日至2020年5月24日每日确诊增长率数值辅助开展分析，预估GDP-TOP10的国家发展趋势。


### 4.2.2 方法说明
**(1) 曲线拟合方法**

　　曲线拟合（curve fitting）是指选择适当的曲线类型来拟合观测数据，并用拟合的曲线方程分析变量之间的关系。本章节将每日累计确诊病例数据制成散点图，采用单个变化量对时间的响应进行非线性回归拟合，取得拟合方程的系数，并绘制回归曲线。
 
　　结合$S$值、$R^2$值对拟合程度进行判断，其中$S$值描述了数据值与拟合值的距离，表示评估模型描述响应值的程度，其值越低，模型描述响应的程度越高；$R^2$值是度量拟合优度的统计量，介于$0-1$之间，也称拟合的确定系数，$R^2$越高可表示拟合优度越高。$S$值和$R^2$值表达式如下所示：
$$S = \sum_{i=1}^{n}\qquad (y_i-\hat{y_i})$$
$$R^2=1-\frac {SSE*(n-k)}{(var(y))*(n-1)}$$


**(2) Logistic 增长曲线**

　　本章节所采用的R包为**nlrwrb**包中的**nls()**函数，相关使用可参考《Nonlinear Regression with R》。函数**nls()**自带一组自启动函数，即"self-starter functions"，其可以自动设置初始值，Logistic的自启动函数为$SSlogis(x,Asym,xmid,scal)$，其表达式为：

$$\frac{Asym}{(1 + exp(\frac{xmid−x}{scal}))}$$与Logistic函数表达式略有不同，此处参数$Asym$代表渐近线的数字参数，其值可被作为最终流行规模的预测值，及Logistic函数表达式中的$K$值，参数$xmid$表示曲线拐点处的值，参数$scal$表示x轴上的数字比例参数。


**(3) 每日确诊增长率数值**

　　本章节所采用的每日确诊增长率数值的表达式为：$$r(t):=log(\frac{P(t)}{P(t-1)})$$
参考《neralized logistic growth modeling of the COVID-19 outbreak in 29 provinces in China and in the rest of the world》


## 4.3 结果与分析

```{r,echo=FALSE,error=TRUE,warning=FALSE,message=TRUE}
library(tidyverse)
library('nlrwr')
library(ggplot2)
library(ggpubr)
```

### 4.3.1累计确诊病例回归结果分析

```{r,include=FALSE,error=TRUE,warning=FALSE,message=TRUE}
#读取数据
library(tidyverse)
GDP_10 <- read_csv('data/GDP_TOP10_dataF.csv')

days <- GDP_10[,1]
days <- unlist(days)
US <- GDP_10[,2]
US <- unlist(US)
CN <- GDP_10[,3]
CN <- unlist(CN)
JP <- GDP_10[,4]
JP <- unlist(JP)
GE <- GDP_10[,5]
GE <- unlist(GE)
IN <- GDP_10[,6]
IN <- unlist(IN)
FR <- GDP_10[,7]
FR <- unlist(FR)
UK <- GDP_10[,8]
UK <- unlist(UK)
BR <- GDP_10[,9]
BR <- unlist(BR)
IT <- GDP_10[,10]
IT <- unlist(IT)
CA <- GDP_10[,11]
CA <- unlist(CA)

#构造数据框
df1 <- as.data.frame(cbind(days,US))
df2 <- as.data.frame(cbind(days,CN))
df3 <- as.data.frame(cbind(days,JP))
df4 <- as.data.frame(cbind(days,GE))
df5 <- as.data.frame(cbind(days,IN))
df6 <- as.data.frame(cbind(days,FR))
df7 <- as.data.frame(cbind(days,UK))
df8 <- as.data.frame(cbind(days,BR))
df9 <- as.data.frame(cbind(days,IT))
df10 <- as.data.frame(cbind(days,CA))

#删去缺失值
df1 <- na.omit(df1)
df2 <- na.omit(df2)
df3 <- na.omit(df3)
df4 <- na.omit(df4)
df5 <- na.omit(df5)
df6 <- na.omit(df6)
df7 <- na.omit(df7)
df8 <- na.omit(df8)
df9 <- na.omit(df9)
df10 <- na.omit(df10)

#模型
fm1 <- nls(US ~ SSlogis(days, Asym1, xmid1, scal1), data = df1)
summary(fm1)
coef(fm1)
confint(fm1)
y_hat1 <- as.vector (predict(fm1,newdata = df1))
R1 <- 1- ((36160^2)*122) / (var(df1$US)*124)
S1 <- sum(df1$US-y_hat1)

fm2 <- nls(CN ~ SSlogis(days, Asym2, xmid2, scal2), data = df2)
summary(fm2)
coef(fm2)
confint(fm2)
y_hat2 <- as.vector (predict(fm2,newdata = df2))
R2 <- 1- ((1524^2)*143) / (var(df2$CN)*145)
S2 <- sum(df2$CN-y_hat2)

fm3 <- nls(JP ~ SSlogis(days, Asym3, xmid3, scal3), data = df3)
summary(fm3)
coef(fm3)
confint(fm3)
y_hat3 <- as.vector(predict(fm3,newdata = df3))
R3 <- 1- ((225.1^2)*128) / (var(df3$JP)*130)
S3 <- sum(df3$JP-y_hat3)

fm4 <- nls(GE ~ SSlogis(days, Asym4, xmid4, scal4), data = df4)
summary(fm4)
coef(fm4)
confint(fm4)
y_hat4 <- as.vector(predict(fm4,newdata = df4))
R4 <- 1- ((4089^2)*115) / (var(df4$GE)*117)
S4 <- sum(df4$GE-y_hat4)

fm5 <- nls(IN ~ SSlogis(days, Asym5, xmid5, scal5), data = df5)
summary(fm5)
coef(fm5)
confint(fm5)
y_hat5 <- as.vector(predict(fm5,newdata = df5))
R5 <- 1- ((1094^2)*113) / (var(df5$IN)*115)
S5 <- sum(df5$IN-y_hat5)

fm6 <- nls(FR ~ SSlogis(days, Asym6, xmid6, scal6), data = df6)
summary(fm6)
coef(fm6)
confint(fm6)
y_hat6 <- as.vector(predict(fm6,newdata = df6))
R6 <- 1- ((2824^2)*118) / (var(df6$FR)*120)
S6 <- sum(df6$FR-y_hat6)

fm7 <- nls(UK ~ SSlogis(days, Asym7, xmid7, scal7), data = df7)
summary(fm7)
coef(fm7)
confint(fm7)
y_hat7 <- as.vector(predict(fm7,newdata = df7))
R7 <- 1- ((4782^2)*111) / (var(df7$UK)*113)
S7 <- sum(df7$UK-y_hat7)

fm8 <- nls(BR ~ SSlogis(days, Asym8, xmid8, scal8), data = df8)
summary(fm8)
coef(fm8)
confint(fm8)
y_hat8 <- as.vector(predict(fm8,newdata = df8))
R8 <- 1- ((2619^2)*86) / (var(df8$BR)*88) 
S8 <- sum(df8$BR-y_hat8)

fm9 <- nls(IT ~ SSlogis(days, Asym9, xmid9, scal9), data = df9)
summary(fm9)
coef(fm9)
confint(fm9)
y_hat9 <- as.vector(predict(fm9,newdata = df9))
R9 <- 1- ((5602^2)*112) / (var(df9$IT)*114)
S9 <- sum(df9$IT-y_hat9)

fm10 <- nls(CA ~ SSlogis(days, Asym10, xmid10, scal10), data = df10)
summary(fm10)
coef(fm10)
confint(fm10)
y_hat10 <- as.vector(predict(fm10,newdata = df10))
R10 <- 1- ((1380^2)*117) / (var(df10$CA)*119)
S10 <- sum(df10$CA-y_hat10)
```

```{r,echo=FALSE,error=TRUE,warning=FALSE,message=FALSE}
country = c("United States","China","Japan","Germany","India","France","United Kingdom","Brazil","Italy","Canada")
R = c(R1,R2,R3,R4,R5,R6,R7,R8,R9,R10)
S = c(S1,S2,S3,S4,S5,S6,S7,S8,S9,S10)
Asym = c(coef(fm1)[1],coef(fm2)[1],coef(fm3)[1],coef(fm4)[1],coef(fm5)[1],coef(fm6)[1],coef(fm7)[1],coef(fm8)[1],coef(fm9)[1],coef(fm10)[1])
lower_Asym = c(confint(fm1)[1,1],confint(fm2)[1,1],confint(fm3)[1,1],confint(fm4)[1,1],confint(fm5)[1,1],confint(fm6)[1,1],confint(fm7)[1,1],confint(fm8)[1,1],confint(fm9)[1,1],confint(fm10)[1,1])
upper_Asym = c(confint(fm1)[1,2],confint(fm2)[1,2],confint(fm3)[1,2],confint(fm4)[1,2],confint(fm5)[1,2],confint(fm6)[1,2],confint(fm7)[1,2],confint(fm8)[1,2],confint(fm9)[1,2],confint(fm10)[1,2])
xmid = c(coef(fm1)[2],coef(fm2)[2],coef(fm3)[2],coef(fm4)[2],coef(fm5)[2],coef(fm6)[2],coef(fm7)[2],coef(fm8)[2],coef(fm9)[2],coef(fm10)[2])
scal = c(coef(fm1)[3],coef(fm2)[3],coef(fm3)[3],coef(fm4)[3],coef(fm5)[3],coef(fm6)[3],coef(fm7)[3],coef(fm8)[3],coef(fm9)[3],coef(fm10)[3])
day = c(125,146,131,118,116,121,114,89,115,120)
tb <- tibble(
  country=country,
  Day = day,
  Asym = Asym,
  lower_Asym = lower_Asym,
  upper_Asym = upper_Asym,
  xmid = xmid,
  scal = scal,
  R_2 = R,
  S = S
)
tb
```

　　从上表中可以看到获得的Logistic增长曲线的参数估计，以及$S$值和$R^2$值。根据$R^2$值一列，可以看到利用Logistics增长曲线对GDP-TOP10的国家自2019年12月31日至2020年5月24日累计确诊病例数据进行拟合效果显著，且在进行回归分析时，GDP-TOP10的国家Logistic增长曲线的估计参数均通过显著性检验。参数Asym代表渐近线的数字参数，通常被用来作为最终流行规模预测值，从表中可以看到疫情由高到低的顺序为：美国、巴西、印度、英国、意大利、德国、法国、加拿大、中国、日本。而我国作为第一人口大国，累计确诊病例远低于其他国家，可见我国政府的管控措施显著。参数xmid表示x曲线拐点处的值,将参数xmid值与Day值比较，可见印度和巴西还未达到拐点值，且印度即将迎来拐点，其他国家均达到拐点。

### 4.3.2累计确诊病例回归拟合分析
```{r,out.width="100%",out.height="100%",echo=FALSE}
#曲线拟合
p1 <- ggplot(df1,aes(days,predict(fm1)))+geom_line()+geom_point(aes(y=US))+geom_hline(yintercept = coef(fm1)[1],lty=2)+theme_bw()+
  theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+xlab("days")+ylab("Number of confirmed cases(US)")

p2 <- ggplot(df2,aes(days,predict(fm2)))+geom_line()+geom_point(aes(y=CN))+geom_hline(yintercept = coef(fm2)[1],lty=2)+theme_bw()+
  theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+xlab("days")+ylab("Number of confirmed cases(CN)")

p3 <- ggplot(df3,aes(days,predict(fm3)))+geom_line()+geom_point(aes(y=JP))+geom_hline(yintercept = coef(fm3)[1],lty=2)+theme_bw()+
  theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+xlab("days")+ylab("Number of confirmed cases(JP)")

p4 <- ggplot(df4,aes(days,predict(fm4)))+geom_line()+geom_hline(yintercept = coef(fm4)[1],lty=2)+geom_point(aes(y=GE))+theme_bw()+
  theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+xlab("days")+ylab("Number of confirmed cases(GE)")

p5 <- ggplot(df5,aes(days,predict(fm5)))+geom_line()+geom_hline(yintercept = coef(fm5)[1],lty=2)+geom_point(aes(y=IN))+theme_bw()+
  theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+xlab("days")+ylab("Number of confirmed cases(IN)")

p6 <- ggplot(df6,aes(days,predict(fm6)))+geom_line()+geom_hline(yintercept = coef(fm6)[1],lty=2)+geom_point(aes(y=FR))+theme_bw()+
  theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+xlab("days")+ylab("Number of confirmed cases(FR)")

p7 <- ggplot(df7,aes(days,predict(fm7)))+geom_line()+geom_hline(yintercept = coef(fm7)[1],lty=2)+geom_point(aes(y=UK))+theme_bw()+
  theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+xlab("days")+ylab("Number of confirmed cases(UK)")

p8 <- ggplot(df8,aes(days,predict(fm8)))+geom_line()+geom_hline(yintercept = coef(fm8)[1],lty=2)+geom_point(aes(y=BR))+theme_bw()+
  theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+xlab("days")+ylab("Number of confirmed cases(BR)")

p9 <- ggplot(df9,aes(days,predict(fm9)))+geom_line()+geom_hline(yintercept = coef(fm9)[1],lty=2)+geom_point(aes(y=IT))+theme_bw()+
  theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+xlab("days")+ylab("Number of confirmed cases(IT)")

p10 <- ggplot(df10,aes(days,predict(fm10)))+geom_line()+geom_hline(yintercept = coef(fm10)[1],lty=2)+geom_point(aes(y=CA))+theme_bw()+
  theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+xlab("days")+ylab("Number of confirmed cases(CA)")

ggarrange(p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,ncol=2,nrow=5,labels=c("US","CN","JP","GE","IN","FR","UK","BR","IT","CA"))
```

　　上述图是利用获得Logistics增长曲线对GDP-TOP10的国家累计确诊病例数据的拟合，从图中可以看到拟合效果良好。中国、日本、德国、法国和意大利这五个国家，疫情基本稳定，总增长量基本平稳，长时间停留在渐近线附近。美国、英国和加拿大这三个国家，刚刚抵达渐进线处，疫情情况还不明朗，政府应加强控制。印度和巴西这两个国家，离渐近线较远，疫情还未达到拐点，累计确诊病例可能会继续上升。

### 4.3.3每日确诊增长率趋势分析
```{r,out.width="100%",out.height="100%",echo=FALSE}
#读取数据
US_r <- GDP_10[,12]
US_r <- unlist(US_r)
CN_r <- GDP_10[,13]
CN_r <- unlist(CN_r)
JP_r <- GDP_10[,14]
JP_r <- unlist(JP_r)
GE_r <- GDP_10[,15]
GE_r <- unlist(GE_r)
IN_r <- GDP_10[,16]
IN_r <- unlist(IN_r)
FR_r <- GDP_10[,17]
FR_r <- unlist(FR_r)
UK_r <- GDP_10[,18]
UK_r <- unlist(UK_r)
BR_r <- GDP_10[,19]
BR_r <- unlist(BR_r)
IT_r <- GDP_10[,20]
IT_r <- unlist(IT_r)
CA_r <- GDP_10[,21]
CA_r <- unlist(CA_r)

#构造数据框
df1_r <- as.data.frame(cbind(days,US_r))
df2_r<- as.data.frame(cbind(days,CN_r))
df3_r <- as.data.frame(cbind(days,JP_r))
df4_r <- as.data.frame(cbind(days,GE_r))
df5_r <- as.data.frame(cbind(days,IN_r))
df6_r <- as.data.frame(cbind(days,FR_r))
df7_r <- as.data.frame(cbind(days,UK_r))
df8_r <- as.data.frame(cbind(days,BR_r))
df9_r <- as.data.frame(cbind(days,IT_r))
df10_r <- as.data.frame(cbind(days,CA_r))

#删去缺失值
df1_r <- na.omit(df1_r)
df2_r <- na.omit(df2_r)
df3_r <- na.omit(df3_r)
df4_r <- na.omit(df4_r)
df5_r <- na.omit(df5_r)
df6_r <- na.omit(df6_r)
df7_r <- na.omit(df7_r)
df8_r <- na.omit(df8_r)
df9_r <- na.omit(df9_r)
df10_r <- na.omit(df10_r)

#画图
p1_r <- ggplot(df1_r,aes(days,US_r))+geom_line()+theme_bw()+
  theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+xlab("days")+ylab("Daily growth rate of confirmed cases(US)")

p2_r <- ggplot(df2_r,aes(days,CN_r))+geom_line()+theme_bw()+
  theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+xlab("days")+ylab("Daily growth rate of confirmed cases(CN)")

p3_r <- ggplot(df3_r,aes(days,JP_r))+geom_line()+theme_bw()+
  theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+xlab("days")+ylab("Daily growth rate of confirmed cases(JP)")

p4_r <- ggplot(df4_r,aes(days,GE_r))+geom_line()+theme_bw()+
  theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+xlab("days")+ylab("Daily growth rate of confirmed cases(GE)")

p5_r <- ggplot(df5_r,aes(days,IN_r))+geom_line()+theme_bw()+
  theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+xlab("days")+ylab("Daily growth rate of confirmed cases(IN)")

p6_r <- ggplot(df6_r,aes(days,FR_r))+geom_line()+theme_bw()+
  theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+xlab("days")+ylab("Daily growth rate of confirmed cases(FR)")

p7_r <- ggplot(df7_r,aes(days,UK_r))+geom_line()+theme_bw()+
  theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+xlab("days")+ylab("Daily growth rate of confirmed cases(UK)")

p8_r <- ggplot(df8_r,aes(days,BR_r))+geom_line()+theme_bw()+
  theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+xlab("days")+ylab("Daily growth rate of confirmed cases(BR)")

p9_r <- ggplot(df9_r,aes(days,IT_r))+geom_line()+theme_bw()+
  theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+xlab("days")+ylab("Daily growth rate of confirmed cases(IT)")

p10_r <- ggplot(df10_r,aes(days,CA_r))+geom_line()+theme_bw()+
  theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank())+xlab("days")+ylab("Daily growth rate of confirmed cases(CA)")

ggarrange(p1_r,p2_r,p3_r,p4_r,p5_r,p6_r,p7_r,p8_r,p9_r,p10_r,ncol=2,nrow=5,labels=c("US","CN","JP","GE","IN","FR","UK","BR","IT","CA"))

```

　　上述图是每日确诊增长率折线图，从图中可以看到中国每日确诊增长率已长时间趋于0。其次，日本每日确诊增长率也开始趋于0，为0.0008。印度和巴西这两个国家每日确诊增长率最大，分别为0.052和0.048，累计确诊病例仍会继续大幅增加。美国、英国、加拿大这三个国家每日确诊增长率为第二大，均在0.013附近。德国、法国、意大利这三个国家每日确诊增长率接近，在0.002附近。


　　综上诉述，中国疫情已经得到控制，疫情防范效果最为突出，是十个国家最先也是最短时间将疫情控制住的国家，也体现我们国家领导人坚持“不计成本，生命至上，人民至上”的原则。日本疫情也基本得到控制，是十个国家第二位将疫情控制住的国家。德国、法国、意大利这三个国家疫情形势相似，疫情也基本得到控制。印度和巴西这两个国家疫情形势较为相似，是十个国家中疫情还仍未达到拐点的两个国家，这两个国家累计确诊病例仍会继续大幅增加，政府应加强管理措施。美国、英国、加拿大这三个国家疫情形势接近，疫情态势还不太明朗。


……

# 5 小结与讨论

……

# 6 致谢

　　弹指间一学期即将过去，在此次课程中我们都收获颇多。首先，感谢学院为我们安排这门课程。其次，感谢闫军老师为我们带来了全新的工具，我们从一个小白一步步入门了git、github以及r Markdown等工具的使用；同时，在学习这门课的过程中，极大的锻炼了我们自主学习和解决问题的能力，这将是我们未来学习生活和职业生涯中及其宝贵的财富。最后，感谢合作伙伴的配合以及同学们的讨论和建议，希望我们在未来都能够正视自己的不足、不断的进取。


# 参考文献
[1] Christian Ritz,Jens Carl Streibig.Nonlinear Regression with R.SpringerLink.2008.Preprint at:https://link.springer.com/book/10.1007/978-0-387-09616-2

[2] Ke Wu,Didier Darcet,Qian Wang,Didier Sornette.Generalized logistic growth modeling of the COVID-19 outbreak in 29 provinces in China and in the rest of the world.medRxiv.2020.Preprint at: https://www.medrxiv.org/content/medrxiv/early/2020/03/16/2020.03.11.20034363.full.pdf

[3]杨吉安,颜忠诚.基于生态模型的新型冠状病毒肺炎疫情分析[J/OL].首都师范大学学报(自然科学版):1-12[2020-05-21]

[4]易大莉,李高明,冷怀明.新型冠状病毒肺炎疫情发展区域差异的聚类分析[J/OL].重庆医科大学学报:1-6[2020-05-27]